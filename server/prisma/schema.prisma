generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")       // Pooled connection (runtime)
  directUrl = env("DIRECT_DATABASE_URL") // Direct connection (migrations)
}

// ─────────────────────────────────────────────────────────────────────────────
// ENUMS
// ─────────────────────────────────────────────────────────────────────────────

enum Role {
  PARENT
  TEACHER
  ADMIN
}

enum PaymentStatus {
  PENDING    // Booking created, PaymentIntent created but not captured
  CAPTURED   // Class completed, funds transferred to teacher
  REFUNDED   // Booking cancelled, funds returned to parent
  FAILED     // Payment failed
}

// ─────────────────────────────────────────────────────────────────────────────
// USER
// ─────────────────────────────────────────────────────────────────────────────

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  password       String    // bcrypt hash — never returned in API responses
  fullName       String
  role           Role      @default(PARENT)
  createdAt      DateTime  @default(now())
  coppaConsentAt DateTime? // COPPA compliance timestamp

  students       Student[]
  teacherProfile TeacherProfile?
}

// ─────────────────────────────────────────────────────────────────────────────
// STUDENT
// ─────────────────────────────────────────────────────────────────────────────

model Student {
  id        String    @id @default(uuid())
  parentId  String
  parent    User      @relation(fields: [parentId], references: [id])
  name      String    // First name only — COPPA data minimization
  age       Int
  createdAt DateTime  @default(now())
  bookings  Booking[]
}

// ─────────────────────────────────────────────────────────────────────────────
// TEACHER PROFILE
// ─────────────────────────────────────────────────────────────────────────────

model TeacherProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])

  bio             String?
  hourlyRate      Int      @default(25) // In USD

  // Stripe Connect
  stripeAccountId String?  // Stripe Express account ID
  stripeOnboarded Boolean  @default(false)

  // Quality management
  strikes         Int      @default(0)
  isSuspended     Boolean  @default(false)

  // Denormalized rating fields — updated atomically in submitReview().
  // Avoids slow AVG() aggregation on every marketplace query.
  ratingAvg       Float    @default(0)
  reviewCount     Int      @default(0)

  createdAt       DateTime @default(now())
  shifts          Shift[]
  reviews         Review[]
}

// ─────────────────────────────────────────────────────────────────────────────
// SHIFT
// ─────────────────────────────────────────────────────────────────────────────

model Shift {
  id        String         @id @default(uuid())
  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id])
  start     DateTime       // Stored in UTC
  end       DateTime       // Stored in UTC
  isBooked  Boolean        @default(false)
  createdAt DateTime       @default(now())
  booking   Booking?
}

// ─────────────────────────────────────────────────────────────────────────────
// BOOKING
// ─────────────────────────────────────────────────────────────────────────────

model Booking {
  id              String        @id @default(uuid())
  shiftId         String        @unique
  shift           Shift         @relation(fields: [shiftId], references: [id])
  studentId       String
  student         Student       @relation(fields: [studentId], references: [id])
  paymentIntentId String?
  paymentStatus   PaymentStatus @default(PENDING)
  amountCents     Int?
  egressId        String?       // LiveKit Egress ID
  recordingUrl    String?       // S3 URL after class recording
  createdAt       DateTime      @default(now())
  review          Review?       // One review per booking, submitted post-class
}

// ─────────────────────────────────────────────────────────────────────────────
// REVIEW
// Submitted by parent after class completes (paymentStatus = CAPTURED).
// Unique constraint on bookingId enforces one review per class at DB level.
// After each insert, TeacherProfile.ratingAvg and reviewCount are recalculated
// atomically inside BookingsService.submitReview().
// ─────────────────────────────────────────────────────────────────────────────

model Review {
  id                  String         @id @default(uuid())
  bookingId           String         @unique
  booking             Booking        @relation(fields: [bookingId], references: [id])
  teacherId           String
  teacher             TeacherProfile @relation(fields: [teacherId], references: [id])
  rating              Int            // 1–5, validated at service layer
  comment             String?        // Optional written feedback
  submittedByParentId String         // Used for authorization checks
  createdAt           DateTime       @default(now())
}
