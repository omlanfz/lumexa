generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id             String          @id @default(uuid())
  email          String          @unique
  password       String
  fullName       String
  createdAt      DateTime        @default(now())
  role           Role            @default(PARENT)
  coppaConsentAt DateTime?
  avatarUrl      String?
  students       Student[]
  teacherProfile TeacherProfile?
}

model Student {
  id         String    @id @default(uuid())
  parentId   String
  name       String
  age        Int
  createdAt  DateTime  @default(now())
  grade      String?
  schoolName String?
  subject    String?
  timezone   String?
  bookings   Booking[]
  parent     User      @relation(fields: [parentId], references: [id])

  @@index([parentId])
}

model TeacherProfile {
  id              String                @id @default(uuid())
  userId          String                @unique
  bio             String?
  hourlyRate      Int                   @default(25)
  createdAt       DateTime              @default(now())
  isSuspended     Boolean               @default(false)
  strikes         Int                   @default(0)
  stripeAccountId String?
  stripeOnboarded Boolean               @default(false)
  ratingAvg       Float                 @default(0)
  reviewCount     Int                   @default(0)
  grades          String[]              @default([])
  points          Int                   @default(0)
  rankTier        Int                   @default(0)
  subjects        String[]              @default([])
  timezone        String?
  weeklyPoints    Int                   @default(0)
  reviews         Review[]
  shifts          Shift[]
  cancellations   TeacherCancellation[]
  user            User                  @relation(fields: [userId], references: [id])

  @@index([ratingAvg(sort: Desc)])
  @@index([isSuspended])
}

model Shift {
  id        String         @id @default(uuid())
  teacherId String
  start     DateTime
  end       DateTime
  isBooked  Boolean        @default(false)
  createdAt DateTime       @default(now())
  booking   Booking?
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id])

  @@index([teacherId, start])
  @@index([start])
  @@index([isBooked])
}

model Booking {
  id                String             @id @default(uuid())
  shiftId           String             @unique
  studentId         String
  createdAt         DateTime           @default(now())
  amountCents       Int?
  egressId          String?
  paymentIntentId   String?
  paymentStatus     PaymentStatus      @default(PENDING)
  recordingUrl      String?
  shift             Shift              @relation(fields: [shiftId], references: [id])
  student           Student            @relation(fields: [studentId], references: [id])
  rescheduleRequest RescheduleRequest?
  review            Review?

  @@index([studentId])
  @@index([paymentStatus])
}

model RescheduleRequest {
  id          String   @id @default(uuid())
  bookingId   String   @unique
  requestedBy String
  newStart    DateTime
  newEnd      DateTime
  reason      String?
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  booking     Booking  @relation(fields: [bookingId], references: [id])
}

model TeacherCancellation {
  id        String         @id @default(uuid())
  teacherId String
  month     Int
  year      Int
  count     Int            @default(0)
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id])

  @@unique([teacherId, month, year])
}

model Review {
  id                  String         @id @default(uuid())
  bookingId           String         @unique
  teacherId           String
  rating              Int
  comment             String?
  submittedByParentId String
  createdAt           DateTime       @default(now())
  booking             Booking        @relation(fields: [bookingId], references: [id])
  teacher             TeacherProfile @relation(fields: [teacherId], references: [id])

  @@index([teacherId])
}

enum Role {
  PARENT
  TEACHER
  ADMIN
}

enum PaymentStatus {
  PENDING
  CAPTURED
  REFUNDED
  FAILED
}
